\chapter{Beschreibung des 5G-AKA Protokolls}
\label{chap:2}

Das 5G-AKA-Protokoll ist eines von mehreren Protokollen des 5G-Standards.
Vor Allem das EAP-AKA-Protokoll und das 5G-AKA-Protokoll sind f\"ur den sicheren Austausch eines Schl\"ussels zust\"andig. 
Bei beiden Protokollen ist der erste Teil der Gleiche bis bei dem Provider eines der Protokolle ausgew\"ahlt wird. %3GPP TS 33.501 V15.34.1 Page 40
Bei beiden Protokollen ist auch der Authentifizierungsvorgang sehr \"ahnlich, wobei jedoch der das 5G-AKA-Protokoll das EAP-AKA-Protokoll darum erweitert, dass es dem Provider, ''home network'' genannt, eine erfolgreiche Authentifizierung nachweist. %3GPP TS 33.501 V15.34.1 Page 43
Daher wird in dieser Ausarbeitung haupts\"achlich auf das 5G-AKA-Protokoll eingegangen.

Beide Protokolle werden gr\"o{\ss}tenteils in der Spezifikation TS 33.501 des 3GPP beschrieben. %3GPP TS 33.501 V15.34.1
Dabei wird die zurzeit neueste Version V15.34.1 herangezogen.

\section{Ziele}

TODO

\section{Das Protokoll}

\subsection{Entities}

In dem Protokoll werden vier grundlegende Entit\"aten beschrieben.
Diese sind das \gls{ue}, die \gls{seaf}, die \gls{ausf} und das \gls{udm}.

\glsreset{ue}
\subsubsection{\gls{ue}}

Das \gls{ue} befindet sich auf dem Smartphone des Nutzers.
Es l\"asst sich in das \gls{me} und das \gls{usim} unterteilen.
In dem \gls{usim} werden f\"ur die Authentifizierung ben\"otigte Schl\"ussel und Benutzerkennungen gespeichert, die f\"ur die eindeutige Identifizierung und Authentifizierung des \gls{ue} ben\"otigt werden. %3GPP TS 33.501 V15.34.1 Page 24
In dem \gls{me} werden die Schl\"ussel, die f\"ur die Kommunikation nach dem 5G-AKA-Protokoll ben\"otigt werden berechnet.

\glsreset{seaf}
\subsubsection{\gls{seaf}}

Die \gls{seaf} ist Teil des mit dem \gls{ue} kommunizierenden Netzwerks, auch \textit{''Serving Network''â€š} genannt.
Sie kommuniziert mit dem \gls{ue} und mit dem korrekten Provider des Benutzers.
Nach erfolgreicher Authentifizierung haben das \gls{ue} und die \gls{seaf} beide einen gemeinsamen Schl\"ussel.%3GPP TS 33.501 V15.34.1 Page 37

\glsreset{ausf}
\subsubsection{\gls{ausf}}

Die \gls{ausf} ist Teil des Providers, bei dem sich der Benutzer die hier verwendete SIM-Karte gekauft hat, auch \textit{''Home Environment''} genannt.
Sie kommuniziert mit der \gls{seaf} und validiert die Antwort des \gls{ue} f\"ur die \gls{seaf}.

\glsreset{udm}
\subsubsection{\gls{udm}}

Das \gls{udm} ist, wie auch die \gls{ausf} Teil des \textit{''Home Environment''}.
Grunds\"atzlich funktioniert es jedoch nicht ohne die \gls{arpf} und die \gls{sidf}.
Daher wird im Weiteren Verlauf oft die Abk\"urzung \gls{udm}/\gls{arpf}/\gls{sidf} verwendet.

Das \gls{udm} und die \gls{arpf} generieren Authentifizierungsvektoren aus den Schl\"usseln, die sie mit dem \gls{usim} teilen.
Die \gls{sidf} gerechnet die Benutzerkennung f\"ur den \gls{udm} und die \gls{arpf} aus einer verschl\"usselten Benutzerkennung, die sie von dem \gls{ausf} erh\"alt.


\subsection{Wichtige Definitionen}
\glsunset{5g-av}
\glsunset{5g-guti}
\glsunset{5g-he-av}
\glsunset{5g-se-av}
\glsunset{ak}
\glsunset{amf}
\glsunset{autn}
\glsunset{ck}
\glsunset{f12345}
\glsunset{hres*}
\glsunset{hxres*}
\glsunset{ik}
\glsunset{k}
\glsunset{k-ausf}
\glsunset{k-seaf}
\glsunset{mac}
\glsunset{rand}
\glsunset{res}
\glsunset{res*}
\glsunset{sn-name}
\glsunset{sqn}
\glsunset{suci}
\glsunset{supi}
\glsunset{xmac}
\glsunset{xres}
\glsunset{xres*}

\glsreset{5g-av}
\subsubsection{\gls{5g-av}}

\glsreset{5g-guti}
\subsubsection{\gls{5g-guti}}

\glsreset{5g-he-av}
\subsubsection{\gls{5g-he-av}}

\glsreset{5g-se-av}
\subsubsection{\gls{5g-se-av}}

\glsreset{ak}
\subsubsection{\gls{ak}}
Der \gls{ak} hat eine L\"ange von 48 Bits und wird zum verschl\"usseln der \gls{sqn} verwendet. %3GPP TS 33.102 V15.1.0 Page 32
L\"asst die \gls{sqn} keine R\"uckschl\"usse auf die Identit\"at oder Position der Nutzers zu so kann der \gls{ak} auch auf 0 gesetzt werden. %3GPP TS 33.102 V15.1.0 Page 25

Der \gls{ak} wird mit der \textit{''Key generating function''} f5 berechnet. Diese Funktion bekommt \gls{rand} als Eingabe und ist von \gls{k} abh\"angig. %3GPP TS 33.102 V15.1.0 Page 26

\glsreset{amf}
\subsubsection{\gls{amf}}
Das \gls{amf} ist eine 16 Bit lange Zahl. %3GPP TS 33.102 V15.1.0 Page 32
Die 16 Bits des \gls{amf} sind von ''0'' bis ''15'' durchnummeriert. %3GPP TS 33.102 V15.1.0 Page 79
0 steht hier f\"ur das \textit{''most significant bit''} und 15 steht f\"ur das \textit{''least significant bit''}.

\begin{itemize}
\item Bit ''0'', auch \textit{''separation bit''} genannt, wird f\"ur das \gls{eps} verwendet und wird bei der Verwendung des \gls{amf} mei{\ss}t explizit angegeben. \\
\item Bits ''1'' bis ''7'' sind f\"ur eine zuk\"unftige Spezifikation reserviert und sollen auf 0 gesetzt werden. \\
\item Bits ''8'' bis ''15'' k\"onnen f\"ur propriet\"are Zwecke verwendet werden, sind aber nicht explizit festgelegt. 
Sie k\"onnen verwendet werden um providerspezifische Anpassungen festzulegen.
Zum Beispiel k\"onnten mehrere Authentifikations-Algorithmen unterst\"utzt werden, indem die Bits ''8'' bis ''15'' den Algorithmus festlegen oder es k\"onnten die Verifikationsparameter der \gls{sqn} durch die Bits bestimmt werden. %3GPP TS 33.102 V15.1.0 Page 77
\end{itemize}

\glsreset{autn}
\subsubsection{\gls{autn}}
Der \gls{autn} besteht aus den drei Komponenten \gls{sqn}$ \oplus $\gls{ak}, \gls{amf} und \gls{mac}.

\begin{itemize}
\item Das \gls{amf} wird ben\"otigt um \gls{mac} zu berechen und um providerspezifische Anpassungen vorzunehmen.
\item Der \gls{mac} wird ben\"otigt um ihn mit dem \gls{xmac} zu vergleichen.
\item Die \gls{sqn}$ \oplus $\gls{ak} soll die \gls{sqn} \"ubermitte\"ln.
Sie wird mit dem \gls{ak} verschl\"usselt um die Identit\"at und Position der Benutzers nicht preiszugeben.
Ist \gls{ak} = 0, dann kann davon ausgegangen werden dass die \gls{sqn} alleine weder Identit\"at noch Position des Benutzers preisgibt.
\end{itemize}

\glsreset{ck}
\subsubsection{\gls{ck}}
Der \gls{ck} ist ein 128 Bit langer Schl\"ussel. %3GPP TS 33.102 V15.1.0 Page 32
Er wird von der \textit{''Key generating function''} f3 berechnet.
Diese Funktion ist von \gls{k} abh\"angig und bekommt \gls{rand} als Eingabe. %3GPP TS 33.102 V15.1.0 Page 26

Der \gls{ck} und der \gls{ik} werden ben\"otigt um \gls{k-ausf} zu berechnen.

\glsreset{f12345}
\subsubsection{\gls{f12345}}
Mit diesen Funktionen werden \gls{ak}, \gls{ck}, \gls{ik} \gls{res} bzw. \gls{xres} und \gls{mac} bzw. \gls{xmac} berechnet. %3GPP TS 33.102 V15.1.0 Page 26
\begin{itemize}
\item f1 ist eine \textit{''Message authentication function''}.
Sie berechnet in Abh\"angigkeit von \gls{k} den \gls{mac} bzw. \gls{xmac} und bekommt als Eingabe die Konkatenation von \gls{sqn}, \gls{rand} und \gls{amf} (\gls{sqn} || \gls{rand} || \gls{amf}). \\
\item f2 ist eine, m\"oglicherweise verk\"urzte, \textit{''Message authentication function''}.
Sie berechnet in Abh\"angigkeit von \gls{k} die \gls{res} bzw. \gls{xres} und bekommt \gls{rand} als Eingabe.
\item f3, f4 und f5 sind \textit{''Key generating functions''}.
f3 berechnet \gls{ck}, f4 berechnet \gls{ik} und f5 berechnet \gls{ak}.
Alle drei bekomment \gls{rand} als Eingabe und sind abh\"angig von \gls{k}.
Falls \gls{sqn} keine R\"uckschl\"usse auf die Identit\"at oder Position des Benutzers zul\"asst wird f5 = 0 gesetzt.
\end{itemize}

\glsreset{hres*}
\subsubsection{\gls{hres*}}

\glsreset{hxres*}
\subsubsection{\gls{hxres*}}

\glsreset{ik}
\subsubsection{\gls{ik}}
Der \gls{ik} ist ein 128 Bit langer Schl\"ussel. %3GPP TS 33.102 V15.1.0 Page 32
Er wird von der \textit{''Key generating function''} f4 berechnet.
Diese Funktion ist von \gls{k} abh\"angig und bekommt \gls{rand} als Eingabe. %3GPP TS 33.102 V15.1.0 Page 26

Der \gls{ik} wird zusammen mit dem \gls{ck} ben\"otigt um \gls{k-ausf} zu berechnen.

\glsreset{k}
\subsubsection{\gls{k}}
\gls{k} ist ein Langzeitschl\"ussel mit einer L\"ange von 128 oder 256 Bits. %3GPP TS 33.102 V15.1.0 Page 32
Die tats\"achliche L\"ange ist nicht spezifiziert und wird m\"oglicherweise von Provider festgelegt. %3GPP TS 33.102 V15.1.0 Page 32

\gls{k} soll auf dem \gls{udm}/\gls{arpf} und in einer manipulationssicheren Hardwarekomponente auf dem \gls{ue} gespeichert werden.  %3GPP TS 33.501 V15.34.1 Page 29
Er wird f\"ur die Generierung von \gls{ak}, \gls{ck}, \gls{ik} \gls{res} bzw. \gls{xres} und \gls{mac} bzw. \gls{xmac} ben\"otigt. 

\glsreset{k-ausf}
\subsubsection{\gls{k-ausf}}

\glsreset{k-seaf}
\subsubsection{\gls{k-seaf}}

\glsreset{mac}
\subsubsection{\gls{mac}}
Der \gls{mac} hat eine L\"ange von 64 Bits und wird, wie auch der \gls{xmac}, mit der \textit{''Message authentication function''} f1 berechnet. %3GPP TS 33.102 V15.1.0 Page 32
Die Funktion f1 ist von \gls{k} abh\"angig und bekommt als Eingabe die Konkatenation von \gls{sqn}, \gls{rand} und \gls{amf} (\gls{sqn} || \gls{rand} || \gls{amf}). %3GPP TS 33.102 V15.1.0 Page 26

Der \gls{mac} wird von der \gls{udm}/\gls{arpf} berechnet und an die \gls{ausf} geschickt, damit er im weiteren Verlauf des Protokolls vom \gls{ue} mit dem \gls{xmac} vergleichen werden kann.

\glsreset{rand}
\subsubsection{\gls{rand}}
\gls{rand} ist eine 128 Bit lange zuf\"allige Zahl. %3GPP TS 33.102 V15.1.0 Page 32
Sie wird f\"ur die Generierung von \gls{ak}, \gls{ck}, \gls{ik} \gls{res} bzw. \gls{xres} und \gls{mac} bzw. \gls{xmac} ben\"otigt. 
\gls{rand} soll eine unvorhersehbare Zahl sein, wie genau sie generiert wird ist jedoch nicht beschrieben. %3GPP TS 33.102 V15.1.0 Page 25

Sie wird vom \gls{udm}/\gls{arpf} erzeugt und an das \gls{ue} weitergeleitet. Diese Entit\"aten generieren auch die oben genannten Schl\"ussel \gls{ak}, \gls{ck}, \gls{ik}, usw.

\glsreset{res}
\subsubsection{\gls{res}}
Die \gls{res} hat eine variable L\"ange von bis zu 416 Bytes. %3GPP TS 33.102 V15.1.0 Page 32
Sie wird von dem \gls{ue} mit der \textit{''Message authentication function''} f2 berechnet.
Deise Funktion bekommt \gls{rand} als Eingabe und ist von \gls{k} abh\"angig. %3GPP TS 33.102 V15.1.0 Page 26

Die \gls{res} wird von der \gls{ausf} mit der \gls{xres} verglichen.
Stimmen sie nicht \"uberein so bricht die \gls{ausf} die Authentifizierung ab. %3GPP TS 33.501 V15.34.1 Page 45

\glsreset{res*}
\subsubsection{\gls{res*}}

\glsreset{sn-name}
\subsubsection{\gls{sn-name}}

\glsreset{sqn}
\subsubsection{\gls{sqn}}
\gls{sqn} ist eine Zahl mit einer L\"ange von 48 Bits. %3GPP TS 33.102 V15.1.0 Page 32
Aus ihr wird der \gls{mac} bwz. \gls{xmac} erzeugt. %3GPP TS 33.102 V15.1.0 Page 25

F\"ur die Generierugn der \gls{sqn} muss das \gls{udm}/\gls{arpf} folgende Bedingungen erf\"ullen:\\%3GPP TS 33.102 V15.1.0 Page 25
\begin{enumerate}
\item Der Erzeugungsmechanismus der \gls{sqn} soll eine Re-Synchronisations Prozedur beinhalten.\\
\item Falls die \gls{sqn} R\"uckschl\"usse auf die Identit\"at oder Position des Nutzers zul\"asst, dann soll der \gls{ak} verwendet werden um die \gls{sqn} zu verbergen.\\
\item Der Erzeugungsmechanismus soll gegen den \"Uberlauf der \gls{sqn} (\textit{''Wrap around Protection''}) gesch\"utzt sein, da sonst bereits verwendete Schl\"ussel erneut verwendet werden k\"onnten. 
\end{enumerate}

\glsreset{suci}
\subsubsection{\gls{suci}}

\glsreset{supi}
\subsubsection{\gls{supi}}

\glsreset{xmac}
\subsubsection{\gls{xmac}}
Der \gls{xmac} hat eine L\"ange von 64 Bits und wird wie auch der \gls{mac} mit der Funktion f1 berechnet. %3GPP TS 33.102 V15.1.0 Page 32
Die \textit{''Message authentication function''} f1 ist von \gls{k} abh\"angig und bekommt als Eingabe die Konkatenation von \gls{sqn}, \gls{rand} und \gls{amf} (\gls{sqn} || \gls{rand} || \gls{amf}). %3GPP TS 33.102 V15.1.0 Page 27

Der \gls{xmac} wird von dem \gls{ue} berechnet und mit dem \gls{mac} verglichen. 
Den \gls{mac} hat das \gls{ue} bereits von der \gls{seaf} erhalten.
Stimmen \gls{mac} und \gls{xmac} nicht \"uberein, so soll das \gls{ue} die Authentifizierung abbrechen. %3GPP TS 33.102 V15.1.0 Page 27

\glsreset{xres}
\subsubsection{\gls{xres}}
Die \gls{xres} hat eine variable L\"ange von bis zu 416 Bytes. %3GPP TS 33.102 V15.1.0 Page 32
Sie wird, wie auch die \gls{res}, mit der \textit{''Message authentication function''} f2 berechnet. 
Diese Funktion ist von \gls{k} abh\"angig undbekommt \gls{rand} als Eingabe. %3GPP TS 33.102 V15.1.0 Page 26

Die \gls{ausf} vergleicht \gls{res} und \gls{xres} miteinander.
Stimmen sie nicht \"uberein so bricht die \gls{ausf} die Authentifizierung ab. %3GPP TS 33.501 V15.34.1 Page 45

\glsreset{xres*}
\subsubsection{\gls{xres*}}




\subsection{Weitere Begriffe}

\glsreset{abba}
\subsubsection{\gls{abba}}

\glsreset{auts}
\subsubsection{\gls{auts}}

\glsreset{ng-ksi}
\subsubsection{\gls{ng-ksi}}
















